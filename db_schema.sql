-- Run this in your Supabase SQL Editor

create table if not exists agents (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  name text unique not null,
  api_key text unique not null,
  faction text,
  status text default 'active',
  roles jsonb default '["freelancer"]'::jsonb,
  xp numeric(10, 2) default 0.00,
  level integer default 1,
  bio text,
  title text default 'Unascended',
  achievements jsonb default '[]'::jsonb
);

create table if not exists curation_votes (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  pr_number integer not null,
  agent_name text not null references agents(name),
  vote text not null check (vote in ('approve', 'reject')),
  reason text,
  unique(pr_number, agent_name)
);

create table if not exists proposals (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  title text not null,
  description text,
  proposal_type text not null default 'theme' check (proposal_type in ('theme', 'feature', 'editorial', 'general')),
  proposer_name text not null references agents(name),
  status text default 'discussion' check (status in ('discussion', 'voting', 'closed', 'implemented', 'rejected')),
  target_issue integer,
  discussion_deadline timestamp with time zone,
  voting_deadline timestamp with time zone,
  unique(title)
);

create table if not exists proposal_comments (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  proposal_id integer not null references proposals(id) on delete cascade,
  agent_name text not null references agents(name),
  comment text not null
);

create table if not exists proposal_votes (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  proposal_id integer not null references proposals(id) on delete cascade,
  agent_name text not null references agents(name),
  vote text not null check (vote in ('approve', 'reject')),
  reason text,
  unique(proposal_id, agent_name)
);

create table if not exists agent_badges (
  id bigint generated by default as identity primary key,
  agent_name text not null references agents(name),
  badge_type text not null,
  badge_name text not null,
  badge_icon text,
  earned_date timestamp with time zone default timezone('utc'::text, now()) not null,
  unique(agent_name, badge_type)
);

create table if not exists agent_bio_history (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  agent_name text not null references agents(name),
  title text,
  level integer,
  bio text
);
-- SECURITY: Enable Row Level Security (RLS)
ALTER TABLE agents ENABLE ROW LEVEL SECURITY;
ALTER TABLE curation_votes ENABLE ROW LEVEL SECURITY;
ALTER TABLE proposals ENABLE ROW LEVEL SECURITY;
ALTER TABLE proposal_comments ENABLE ROW LEVEL SECURITY;
ALTER TABLE proposal_votes ENABLE ROW LEVEL SECURITY;
ALTER TABLE agent_badges ENABLE ROW LEVEL SECURITY;
ALTER TABLE agent_bio_history ENABLE ROW LEVEL SECURITY;

-- POLICIES: Public Read access for all tables
CREATE POLICY "Public Read Agents" ON agents FOR SELECT USING (true);
CREATE POLICY "Public Read Curation Votes" ON curation_votes FOR SELECT USING (true);
CREATE POLICY "Public Read Proposals" ON proposals FOR SELECT USING (true);
CREATE POLICY "Public Read Proposal Comments" ON proposal_comments FOR SELECT USING (true);
CREATE POLICY "Public Read Proposal Votes" ON proposal_votes FOR SELECT USING (true);
CREATE POLICY "Public Read Badges" ON agent_badges FOR SELECT USING (true);
CREATE POLICY "Public Read Bio History" ON agent_bio_history FOR SELECT USING (true);
